@page "/editpage/{PageId:int}/{SiteId:int}"
@using CoreBuilder.Entities
@using CoreBuilder.Data
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Hosting
@using System.IO
@using System.Text.Json
@using System.Text.RegularExpressions
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject NavigationManager NavManager
@inject IWebHostEnvironment WebEnvironment
@rendermode InteractiveServer

<div class="container-fluid pb-5">
    <div class="d-flex justify-content-between align-items-center mb-4 sticky-top bg-white py-3 border-bottom" style="z-index: 1000;">
        <div>
            <h3 class="fw-bold text-dark mb-0">
                <i class="fa-solid fa-wand-magic-sparkles text-primary me-2"></i>
                @(pageModel.Id == 0 ? "Yeni Sayfa Oluştur" : "Sayfayı Düzenle")
            </h3>
            <span class="text-muted small">
                @(string.IsNullOrEmpty(pageModel.Title) ? "Başlık bekleniyor..." : pageModel.Title)
            </span>
        </div>
        <div class="d-flex gap-2">
            @if (pageModel.Id != 0 && !string.IsNullOrEmpty(pageModel.Slug))
            {
                <button type="button" class="btn btn-outline-info shadow-sm" @onclick="OpenPreview">
                    <i class="fa-solid fa-eye me-2"></i>Siteyi Önizle
                </button>
            }
            <button class="btn btn-light border shadow-sm" @onclick="GoBack">
                <i class="fa-solid fa-arrow-left me-2"></i>Geri
            </button>
            <button class="btn btn-primary shadow-sm px-4" @onclick="HandleSubmit">
                <i class="fa-solid fa-save me-2"></i>Kaydet & Yayınla
            </button>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary"></div>
            <p class="mt-2 text-muted">Sayfa verileri hazırlanıyor...</p>
        </div>
    }
    else
    {
        <EditForm Model="@pageModel" OnValidSubmit="HandleSubmit">
            <DataAnnotationsValidator />

            <div class="row">
                <div class="col-lg-3">
                    <div class="card shadow-sm border-0 mb-4 sticky-top" style="top: 100px;">
                        <div class="card-header bg-light fw-bold text-uppercase small ls-1">
                            <i class="fa-solid fa-gear me-2"></i>Genel Ayarlar
                        </div>
                        <div class="card-body">

                            <div class="mb-3">
                                <label class="form-label fw-bold small">Sayfa Türü</label>
                                <InputSelect class="form-select" @bind-Value="pageData.PageType">
                                    <option value="Standard">Standart İçerik Sayfası</option>
                                    <option value="Contact">İletişim Sayfası</option>
                                </InputSelect>
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-bold small">Sayfa Başlığı</label>
                                <InputText class="form-control"
                                           Value="@pageModel.Title"
                                           ValueExpression="@(() => pageModel.Title)"
                                           ValueChanged="@OnTitleChanged"
                                           placeholder="Örn: Hakkımızda" />
                                <ValidationMessage For="@(() => pageModel.Title)" />
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-bold small">Link (Slug)</label>
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text bg-light">/</span>
                                    <InputText class="form-control" @bind-Value="pageModel.Slug" placeholder="Otomatik oluşur" />
                                </div>
                                <div class="form-text" style="font-size: 0.75rem;">Boş bırakırsanız başlıktan otomatik üretilir.</div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-bold small">Menü Konumu</label>
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="menuType" id="mainMenu"
                                           checked="@(menuSelection == 0)" @onchange="@(() => menuSelection = 0)">
                                    <label class="btn btn-outline-primary" for="mainMenu">Ana Menü</label>

                                    <input type="radio" class="btn-check" name="menuType" id="subMenu"
                                           checked="@(menuSelection == 1)" @onchange="@(() => menuSelection = 1)">
                                    <label class="btn btn-outline-primary" for="subMenu">Alt Menü</label>
                                </div>

                                @if (menuSelection == 1)
                                {
                                    <div class="mt-2 animate__animated animate__fadeIn p-2 bg-light border rounded">
                                        <label class="small text-muted fw-bold">Hangi sayfanın altında?</label>
                                        @if (parentPages != null && parentPages.Any())
                                        {
                                            <InputSelect class="form-select form-select-sm" @bind-Value="pageModel.ParentId">
                                                <option value="">-- Bir Ana Sayfa Seçin --</option>
                                                @foreach (var p in parentPages)
                                                {
                                                    <option value="@p.Id">@p.Title</option>
                                                }
                                            </InputSelect>
                                        }
                                        else
                                        {
                                            <div class="text-danger small mt-1">Ana menü olabilecek sayfa yok.</div>
                                        }
                                    </div>
                                }
                            </div>

                            <div class="form-check form-switch p-3 bg-light rounded border">
                                <InputCheckbox class="form-check-input" @bind-Value="pageModel.IsPublished" id="pub" />
                                <label class="form-check-label fw-bold" for="pub">Sayfayı Yayınla</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-9">

                    @if (pageData.PageType == "Contact")
                    {
                        <div class="alert alert-primary shadow-sm mb-4">
                            <i class="fa-solid fa-info-circle me-2"></i>
                            <strong>İletişim Modu:</strong> Aşağıdaki bilgileri doldurduğunuzda web sitesinde otomatik olarak iletişim kartları ve "Bize Yazın" formu oluşacaktır.
                        </div>

                        <div class="card shadow-sm border-0 mb-4 border-top border-4 border-primary">
                            <div class="card-header bg-white fw-bold">
                                <i class="fa-solid fa-address-book me-2"></i>İletişim ve Adres Bilgileri
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-12">
                                        <label class="form-label fw-bold small">Açık Adres</label>
                                        <InputText @bind-Value="pageData.Contact.AddressText" class="form-control" placeholder="Mahalle, Cadde, Sokak, No..." />
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold small">İlçe</label>
                                        <InputText @bind-Value="pageData.Contact.District" class="form-control" placeholder="Merkez" />
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold small">İl</label>
                                        <InputText @bind-Value="pageData.Contact.City" class="form-control" placeholder="Bartın" />
                                    </div>

                                    <div class="col-12"><hr class="text-muted" /></div>

                                    <div class="col-md-6">
                                        <label class="form-label fw-bold small">1. Telefon Etiketi</label>
                                        <InputText @bind-Value="pageData.Contact.PhoneLabel1" class="form-control" placeholder="Örn: Santral, Sabit Hat" />
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold small">1. Telefon Numarası</label>
                                        <InputText @bind-Value="pageData.Contact.Phone1" class="form-control" placeholder="0378 227 00 00" />
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label fw-bold small">2. Telefon Etiketi (Opsiyonel)</label>
                                        <InputText @bind-Value="pageData.Contact.PhoneLabel2" class="form-control" placeholder="Örn: Cep, WhatsApp Hattı" />
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold small">2. Telefon Numarası</label>
                                        <InputText @bind-Value="pageData.Contact.Phone2" class="form-control" placeholder="05XX XXX XX XX" />
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label fw-bold small">E-Posta Adresi</label>
                                        <InputText @bind-Value="pageData.Contact.Email1" class="form-control" placeholder="info@ornek.com" />
                                    </div>

                                    <div class="col-12"><hr class="text-muted" /></div>

                                    <div class="col-md-6">
                                        <label class="form-label fw-bold small">Çalışma Günleri</label>
                                        <InputText @bind-Value="pageData.Contact.WorkingDays" class="form-control" placeholder="Pazartesi - Cumartesi" />
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold small">Çalışma Saatleri</label>
                                        <InputText @bind-Value="pageData.Contact.WorkingHours" class="form-control" placeholder="08:30 - 19:00" />
                                    </div>

                                    <div class="col-12"><hr class="text-muted" /></div>

                                    <div class="col-12"><label class="form-label fw-bold small text-primary"><i class="fa-solid fa-share-nodes me-1"></i>Sosyal Medya & Linkler</label></div>

                                    <div class="col-md-6">
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text bg-success text-white"><i class="fa-brands fa-whatsapp"></i></span>
                                            <InputText @bind-Value="pageData.Contact.Whatsapp" class="form-control" placeholder="https://wa.me/905xxxxxxxxx" />
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text bg-danger text-white"><i class="fa-brands fa-instagram"></i></span>
                                            <InputText @bind-Value="pageData.Contact.Instagram" class="form-control" placeholder="https://instagram.com/..." />
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text bg-primary text-white"><i class="fa-brands fa-facebook"></i></span>
                                            <InputText @bind-Value="pageData.Contact.Facebook" class="form-control" placeholder="https://facebook.com/..." />
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text bg-dark text-white"><i class="fa-brands fa-x-twitter"></i></span>
                                            <InputText @bind-Value="pageData.Contact.Twitter" class="form-control" placeholder="https://twitter.com/..." />
                                        </div>
                                    </div>

                                    <div class="col-12"><hr class="text-muted" /></div>

                                    <div class="col-md-12">
                                        <label class="form-label fw-bold small">Google Harita Kodu (Embed/Iframe)</label>
                                        <InputTextArea @bind-Value="pageData.Contact.MapEmbedCode" class="form-control font-monospace small" rows="4" placeholder="<iframe src='https://www.google.com/maps/embed...' ...></iframe>" />
                                        <div class="form-text small text-muted">Google Maps'te yerinizi bulun, <strong>Paylaş -> Harita Yerleştir</strong> diyerek verilen HTML kodunu buraya yapıştırın.</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="card shadow-sm border-0 mb-4">
                            <div class="card-body">
                                <h6 class="fw-bold small text-muted mb-3 text-uppercase">Sayfaya Özellik Ekle</h6>
                                <div class="d-flex gap-2 flex-wrap">
                                    <button type="button" class="btn @(pageData.HasSlider ? "btn-primary" : "btn-outline-secondary")"
                                            @onclick="() => pageData.HasSlider = !pageData.HasSlider">
                                        <i class="fa-solid fa-images me-2"></i>Slider
                                    </button>
                                    <button type="button" class="btn @(pageData.HasAnnouncements ? "btn-warning" : "btn-outline-secondary")"
                                            @onclick="() => pageData.HasAnnouncements = !pageData.HasAnnouncements">
                                        <i class="fa-solid fa-bullhorn me-2"></i>Duyurular
                                    </button>
                                    <button type="button" class="btn @(pageData.HasNews ? "btn-info text-white" : "btn-outline-secondary")"
                                            @onclick="() => pageData.HasNews = !pageData.HasNews">
                                        <i class="fa-solid fa-newspaper me-2"></i>Haberler
                                    </button>
                                    <button type="button" class="btn @(pageData.HasGallery ? "btn-success" : "btn-outline-secondary")"
                                            @onclick="() => pageData.HasGallery = !pageData.HasGallery">
                                        <i class="fa-solid fa-photo-film me-2"></i>Medya Galeri
                                    </button>
                                </div>
                            </div>
                        </div>

                        @if (pageData.HasSlider)
                        {
                            <div class="card shadow-sm border-0 mb-4 border-start border-4 border-primary">
                                <div class="card-header bg-white"><h6 class="text-primary fw-bold mb-0">Slider</h6></div>
                                <div class="card-body bg-light">
                                    <div class="row g-2 mb-3 align-items-end">
                                        <div class="col-md-3"><label class="small fw-bold">Görsel / Video</label><InputFile OnChange="@(e => UploadFiles(e, "slider"))" class="form-control form-control-sm" /></div>
                                        <div class="col-md-3"><label class="small fw-bold">Başlık</label><input type="text" class="form-control form-control-sm" @bind="tempSlider.Title" /></div>
                                        <div class="col-md-4">
                                            <label class="small fw-bold">Link (URL - Opsiyonel)</label>
                                            <input type="text" class="form-control form-control-sm" @bind="tempSlider.LinkUrl" placeholder="https://" />
                                        </div>
                                        <div class="col-md-2">
                                            @if (editingSliderIndex.HasValue)
                                            {
                                                <button type="button" class="btn btn-sm btn-success w-100" @onclick="SaveSliderEdit"><i class="fa-solid fa-check me-1"></i>Kaydet</button>
                                            }
                                            else
                                            {
                                                <button type="button" class="btn btn-sm btn-primary w-100" @onclick="AddSliderItem">Ekle</button>
                                            }
                                        </div>
                                    </div>

                                    @if (isUploading)
                                    {
                                        <div class="text-primary small mb-2">
                                            <span class="spinner-border spinner-border-sm me-1"></span> @uploadStatus
                                        </div>
                                    }

                                    @if (editingSliderIndex.HasValue)
                                    {
                                        <div class="alert alert-info py-2 mb-3">
                                            <i class="fa-solid fa-pen me-2"></i>Düzenleme modu aktif.
                                            <button type="button" class="btn btn-sm btn-outline-secondary ms-2" @onclick="CancelSliderEdit">İptal</button>
                                        </div>
                                    }
                                    <div class="list-group">
                                        @for (int i = 0; i < pageData.Sliders.Count; i++)
                                        {
                                            var index = i;
                                            var item = pageData.Sliders[index];
                                            <div class="list-group-item d-flex justify-content-between align-items-center @(editingSliderIndex == index ? "bg-warning bg-opacity-10 border-warning" : "")">
                                                <div class="d-flex align-items-center">
                                                    @if (IsVideo(item.ImageUrl))
                                                    {
                                                        <video src="@item.ImageUrl" style="width: 40px; height: 30px; object-fit:cover;" class="me-2"></video>
                                                    }
                                                    else
                                                    {
                                                        <img src="@item.ImageUrl" style="width: 40px; height: 30px; object-fit:cover;" class="me-2" />
                                                    }
                                                    <span>@item.Title</span>
                                                </div>
                                                <div>
                                                    <button type="button" class="btn btn-sm btn-outline-primary me-1" @onclick="() => EditSliderItem(index)" title="Düzenle"><i class="fa-solid fa-pen"></i></button>
                                                    <button type="button" class="btn btn-sm btn-outline-danger" @onclick="() => pageData.Sliders.RemoveAt(index)">×</button>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        }

                        @if (pageData.HasNews)
                        {
                            <div class="card shadow-sm border-0 mb-4 border-start border-4 border-info">
                                <div class="card-header bg-white"><h6 class="text-info fw-bold mb-0">Haberler</h6></div>
                                <div class="card-body bg-light">
                                    <div class="row g-2 mb-3">
                                        <div class="col-md-3"><label class="small fw-bold">Görsel</label><InputFile OnChange="@(e => UploadFiles(e, "news"))" class="form-control form-control-sm" /></div>
                                        <div class="col-md-4"><label class="small fw-bold">Başlık</label><input type="text" class="form-control form-control-sm" @bind="tempNews.Title" placeholder="Haber Başlığı" /></div>
                                        <div class="col-md-5"><label class="small fw-bold">Özet</label><input type="text" class="form-control form-control-sm" @bind="tempNews.Summary" placeholder="Kısa Özet" /></div>
                                        <div class="col-md-5">
                                            <label class="small fw-bold text-muted">Link (URL - Opsiyonel)</label>
                                            <input type="text" class="form-control form-control-sm" @bind="tempNews.LinkUrl" placeholder="https://..." />
                                        </div>
                                        <div class="col-md-7"><label class="small fw-bold text-muted">İçerik (Opsiyonel)</label><input type="text" class="form-control form-control-sm" @bind="tempNews.Content" placeholder="Detaylı metin..." /></div>
                                    </div>

                                    <div class="mb-3">
                                        @if (editingNewsIndex.HasValue)
                                        {
                                            <button type="button" class="btn btn-sm btn-success" @onclick="SaveNewsEdit"><i class="fa-solid fa-check me-1"></i>Kaydet</button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary ms-2" @onclick="CancelNewsEdit">İptal</button>
                                        }
                                        else
                                        {
                                            <button class="btn btn-sm btn-info text-white" @onclick="AddNewsItem">Ekle</button>
                                        }
                                    </div>

                                    <div class="row g-2">
                                        @for (int i = 0; i < pageData.NewsItems.Count; i++)
                                        {
                                            var index = i;
                                            var item = pageData.NewsItems[index];
                                            <div class="col-md-6">
                                                <div class="border bg-white p-2 rounded @(editingNewsIndex == index ? "border-warning border-2" : "")">
                                                    <div class="d-flex align-items-center justify-content-between">
                                                        <div class="d-flex align-items-center">
                                                            @if (!string.IsNullOrEmpty(item.ImageUrl))
                                                            {
                                                                <img src="@item.ImageUrl" style="width:40px;height:40px;object-fit:cover" class="me-2 rounded" />
                                                            }
                                                            <div>
                                                                <div class="fw-bold small">@item.Title</div>
                                                                <div class="small text-muted" style="font-size:0.75rem">@item.Summary</div>
                                                            </div>
                                                        </div>
                                                        <div>
                                                            <button type="button" class="btn btn-sm btn-outline-primary me-1 p-0 px-1" @onclick="() => EditNewsItem(index)"><i class="fa-solid fa-pen"></i></button>
                                                            <button class="btn btn-sm btn-danger p-0 px-1" @onclick="() => pageData.NewsItems.RemoveAt(index)">×</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        }

                        @if (pageData.HasAnnouncements)
                        {
                            <div class="card shadow-sm border-0 mb-4 border-start border-4 border-warning">
                                <div class="card-header bg-white"><h6 class="text-warning fw-bold mb-0">Duyurular</h6></div>
                                <div class="card-body bg-light">
                                    <div class="row g-2 mb-3">
                                        <div class="col-md-3"><label class="small fw-bold">Dosya/Görsel</label><InputFile OnChange="@(e => UploadFiles(e, "announcements"))" class="form-control form-control-sm" /></div>
                                        <div class="col-md-4"><label class="small fw-bold">Başlık</label><input type="text" class="form-control form-control-sm" @bind="tempAnnouncement.Title" placeholder="Duyuru Başlığı" /></div>
                                        <div class="col-md-5">
                                            <label class="small fw-bold text-muted">Link (URL - Opsiyonel)</label>
                                            <input type="text" class="form-control form-control-sm" @bind="tempAnnouncement.LinkUrl" placeholder="https://..." />
                                        </div>
                                        <div class="col-md-12"><label class="small fw-bold text-muted">İçerik (Ops.)</label><input type="text" class="form-control form-control-sm" @bind="tempAnnouncement.Content" /></div>
                                    </div>

                                    <div class="mb-3">
                                        @if (editingAnnouncementIndex.HasValue)
                                        {
                                            <button type="button" class="btn btn-sm btn-success" @onclick="SaveAnnouncementEdit"><i class="fa-solid fa-check me-1"></i>Kaydet</button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary ms-2" @onclick="CancelAnnouncementEdit">İptal</button>
                                        }
                                        else
                                        {
                                            <button class="btn btn-sm btn-warning" @onclick="AddAnnouncementItem">Ekle</button>
                                        }
                                    </div>

                                    <div class="list-group">
                                        @for (int i = 0; i < pageData.Announcements.Count; i++)
                                        {
                                            var index = i;
                                            var item = pageData.Announcements[index];
                                            <div class="list-group-item d-flex justify-content-between align-items-center @(editingAnnouncementIndex == index ? "bg-warning bg-opacity-10 border-warning" : "")">
                                                <div class="d-flex align-items-center">
                                                    @if (!string.IsNullOrEmpty(item.ImageUrl))
                                                    {
                                                        <img src="@item.ImageUrl" style="width:40px;height:30px;object-fit:cover" class="me-2" />
                                                    }
                                                    <span>@item.Title</span>
                                                </div>
                                                <div>
                                                    <button type="button" class="btn btn-sm btn-outline-primary me-1" @onclick="() => EditAnnouncementItem(index)"><i class="fa-solid fa-pen"></i></button>
                                                    <button type="button" class="btn btn-sm btn-outline-danger" @onclick="() => pageData.Announcements.RemoveAt(index)">×</button>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        }

                        @if (pageData.HasGallery)
                        {
                            <div class="card shadow-sm border-0 mb-4 border-start border-4 border-success">
                                <div class="card-header bg-white"><h6 class="text-success fw-bold mb-0">Medya Galeri</h6></div>
                                <div class="card-body bg-light">
                                    <div class="mb-4 p-3 bg-white border rounded">
                                        <h6 class="fw-bold small text-muted mb-3">
                                            <i class="fa-solid @(editingGalleryIndex.HasValue ? "fa-pen" : "fa-plus-circle") me-2"></i>
                                            @(editingGalleryIndex.HasValue ? "Galeri Öğesini Düzenle" : "Yeni Öğe Ekle")
                                        </h6>
                                        <div class="row g-2 mb-3">
                                            <div class="col-md-4">
                                                <label class="small fw-bold">Görsel / Video</label>
                                                <InputFile OnChange="@(e => UploadFiles(e, "gallery_single"))" class="form-control form-control-sm" />
                                                @if (!string.IsNullOrEmpty(tempGallery.ImageUrl))
                                                {
                                                    <div class="mt-2">
                                                        @if (IsVideo(tempGallery.ImageUrl))
                                                        {
                                                            <video src="@tempGallery.ImageUrl" style="height:60px; object-fit:cover;" class="rounded"></video>
                                                        }
                                                        else
                                                        {
                                                            <img src="@tempGallery.ImageUrl" style="height:60px; object-fit:cover;" class="rounded" />
                                                        }
                                                    </div>
                                                }
                                            </div>
                                            <div class="col-md-4">
                                                <label class="small fw-bold">Başlık</label>
                                                <input type="text" class="form-control form-control-sm" @bind="tempGallery.Title" placeholder="Başlık" />
                                            </div>
                                            <div class="col-md-4">
                                                <label class="small fw-bold">Açıklama</label>
                                                <input type="text" class="form-control form-control-sm" @bind="tempGallery.Description" placeholder="Açıklama..." />
                                            </div>
                                        </div>

                                        <div class="mb-3 p-3 bg-light border rounded">
                                            <label class="small fw-bold text-muted mb-2 d-block">
                                                <i class="fa-solid fa-file-lines me-1"></i> Hangi Sayfalarda Gösterilsin?
                                            </label>
                                            <div class="row g-2">
                                                @foreach (var pg in allPages)
                                                {
                                                    var pgSlug = pg.Slug;
                                                    var pgId = pg.Id;
                                                    <div class="col-md-4 col-6">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox"
                                                                   id="@($"gallery_pg_{pgId}")"
                                                                   checked="@(tempGallery.SelectedPages?.Contains(pgSlug) ?? false)"
                                                                   @onchange="@(e => ToggleGalleryPage(pgSlug, (bool)e.Value))" />
                                                            <label class="form-check-label small" for="@($"gallery_pg_{pgId}")">
                                                                @pg.Title
                                                                @if (pg.Slug?.ToLower().Contains("galeri") == true || pg.Title?.ToLower().Contains("galeri") == true)
                                                                {
                                                                    <span class="badge bg-success ms-1">Ana</span>
                                                                }
                                                            </label>
                                                        </div>
                                                    </div>
                                                }
                                            </div>
                                            <small class="text-muted d-block mt-2">Not: Hiç sayfa seçmezseniz tüm sayfalarda gösterilir.</small>
                                        </div>

                                        <div class="d-flex gap-2">
                                            @if (editingGalleryIndex.HasValue)
                                            {
                                                <button type="button" class="btn btn-sm btn-success" @onclick="SaveGalleryEdit">
                                                    <i class="fa-solid fa-check me-1"></i>Güncelle
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="CancelGalleryEdit">İptal</button>
                                            }
                                            else
                                            {
                                                <button type="button" class="btn btn-sm btn-success" @onclick="AddGalleryItem">
                                                    <i class="fa-solid fa-plus me-1"></i>Ekle
                                                </button>
                                            }
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="small fw-bold text-muted">Toplu Yükleme (Birden Fazla Dosya Seçin)</label>
                                        <div class="input-group input-group-sm">
                                            <InputFile OnChange="@(e => UploadFiles(e, "gallery"))" multiple class="form-control" id="galleryBulkInput" />
                                            <label class="input-group-text bg-success text-white" for="galleryBulkInput">
                                                <i class="fa-solid fa-cloud-arrow-up me-2"></i>Toplu Yükle
                                            </label>
                                        </div>
                                        <small class="text-muted">Not: Toplu yüklenen öğeler varsayılan ayarlarla eklenir, sonra düzenleyebilirsiniz.</small>
                                    </div>

                                    <div class="row g-3">
                                        @for (int i = 0; i < pageData.GalleryItems.Count; i++)
                                        {
                                            var index = i;
                                            var item = pageData.GalleryItems[index];
                                            <div class="col-6 col-md-4 col-lg-3">
                                                <div class="card h-100 border-0 shadow-sm @(editingGalleryIndex == index ? "border border-2 border-warning" : "")">
                                                    <div class="position-relative">
                                                        @if (IsVideo(item.ImageUrl))
                                                        {
                                                            <video src="@item.ImageUrl" class="card-img-top" style="height: 120px; object-fit: cover;"></video>
                                                        }
                                                        else
                                                        {
                                                            <img src="@item.ImageUrl" class="card-img-top" style="height: 120px; object-fit: cover;" />
                                                        }
                                                        <div class="position-absolute top-0 end-0 m-1 d-flex gap-1">
                                                            <button type="button" class="btn btn-primary btn-sm" @onclick="() => EditGalleryItem(index)" title="Düzenle">
                                                                <i class="fa-solid fa-pen"></i>
                                                            </button>
                                                            <button type="button" class="btn btn-danger btn-sm" @onclick="() => pageData.GalleryItems.RemoveAt(index)" title="Sil">
                                                                <i class="fa-solid fa-trash"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <div class="card-body p-2 bg-white">
                                                        <p class="card-text small fw-bold mb-0 text-truncate" title="@item.Title">
                                                            @(string.IsNullOrEmpty(item.Title) ? "(Başlıksız)" : item.Title)
                                                        </p>
                                                        <p class="card-text small text-muted mb-0 text-truncate" style="font-size:0.7rem;" title="@item.Description">
                                                            @(string.IsNullOrEmpty(item.Description) ? "-" : item.Description)
                                                        </p>
                                                        @if (item.SelectedPages != null && item.SelectedPages.Any())
                                                        {
                                                            <small class="text-success" style="font-size:0.65rem;">📄 @item.SelectedPages.Count sayfa</small>
                                                        }
                                                        else
                                                        {
                                                            <small class="text-muted" style="font-size:0.65rem;">📄 Tüm sayfalar</small>
                                                        }
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        }

                        <div class="card shadow-sm border-0 mb-5">
                            <div class="card-header bg-white fw-bold"><i class="fa-solid fa-paragraph me-2"></i>İçerik</div>
                            <div class="card-body p-0">
                                <InputTextArea @bind-Value="pageData.HtmlContent" class="form-control border-0" style="min-height: 300px; padding: 20px;" placeholder="Sayfa içeriğini buraya yazın..." />
                            </div>
                        </div>
                    }

                </div>
            </div>
        </EditForm>
    }
</div>

@code {
    [Parameter] public int PageId { get; set; }
    [Parameter] public int SiteId { get; set; }

    private Page pageModel = new();
    private PageContentData pageData = new();
    private List<Page> parentPages = new();
    private List<Page> allPages = new();
    private bool isLoading = true;
    private int menuSelection = 0;

    private bool isUploading = false;
    private string uploadStatus = "";

    private SliderItem tempSlider = new();
    private NewsItem tempNews = new();
    private AnnouncementItem tempAnnouncement = new();
    private GalleryItem tempGallery = new();

    private int? editingSliderIndex = null;
    private int? editingNewsIndex = null;
    private int? editingAnnouncementIndex = null;
    private int? editingGalleryIndex = null;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            using var context = DbFactory.CreateDbContext();

            allPages = await context.Pages.IgnoreQueryFilters().AsNoTracking()
                .Where(p => p.TenantId == SiteId)
                .ToListAsync();

            parentPages = allPages.Where(p => (p.ParentId == null || p.ParentId == 0) && p.Id != PageId).ToList();

            if (PageId != 0)
            {
                var existingPage = await context.Pages.IgnoreQueryFilters().AsNoTracking().FirstOrDefaultAsync(p => p.Id == PageId);
                if (existingPage != null)
                {
                    pageModel = existingPage;
                    menuSelection = (pageModel.ParentId == null || pageModel.ParentId == 0) ? 0 : 1;
                    if (!string.IsNullOrWhiteSpace(pageModel.ContentJson))
                    {
                        try
                        {
                            var jsonOptions = new JsonSerializerOptions
                            {
                                PropertyNameCaseInsensitive = true,
                                ReadCommentHandling = JsonCommentHandling.Skip,
                                AllowTrailingCommas = true
                            };
                            pageData = JsonSerializer.Deserialize<PageContentData>(pageModel.ContentJson, jsonOptions) ?? new PageContentData();
                        }
                        catch (Exception ex)
                        {
                            Console.WriteLine($"JSON Hatası: {ex.Message}");
                            pageData = new PageContentData();
                        }
                    }
                }
            }
            else
            {
                pageModel = new Page { TenantId = SiteId, IsPublished = true };
                pageData = new PageContentData();
                pageData.PageType = "Standard";
            }
        }
        catch (Exception ex) { Console.WriteLine("Init Error: " + ex.Message); }
        finally { isLoading = false; }
    }

    private void OnTitleChanged(string value)
    {
        pageModel.Title = value;
        pageModel.Slug = CreateSlug(value);
    }

    private string CreateSlug(string title)
    {
        if (string.IsNullOrEmpty(title)) return "";
        string slug = title.ToLowerInvariant();
        slug = slug.Replace("ı", "i").Replace("ğ", "g").Replace("ü", "u").Replace("ş", "s").Replace("ö", "o").Replace("ç", "c");
        slug = Regex.Replace(slug, @"[^a-z0-9\s-]", "");
        slug = Regex.Replace(slug, @"\s+", " ").Trim();
        slug = slug.Replace(" ", "-");
        return slug;
    }

    private async Task HandleSubmit()
    {
        try
        {
            using var context = DbFactory.CreateDbContext();
            int? finalParentId = (menuSelection == 0 || pageModel.ParentId == 0) ? null : pageModel.ParentId;
            pageModel.ContentJson = JsonSerializer.Serialize(pageData);

            if (string.IsNullOrWhiteSpace(pageModel.Slug) && !string.IsNullOrWhiteSpace(pageModel.Title))
            {
                pageModel.Slug = CreateSlug(pageModel.Title);
            }

            if (pageModel.Id == 0)
            {
                pageModel.ParentId = finalParentId;
                pageModel.TenantId = SiteId;
                ClearNavigations(pageModel);
                context.Pages.Add(pageModel);
            }
            else
            {
                var existingPage = await context.Pages.IgnoreQueryFilters().FirstOrDefaultAsync(p => p.Id == pageModel.Id);
                if (existingPage != null)
                {
                    existingPage.Title = pageModel.Title;
                    existingPage.Slug = pageModel.Slug;
                    existingPage.IsPublished = pageModel.IsPublished;
                    existingPage.ParentId = finalParentId;
                    existingPage.ContentJson = pageModel.ContentJson;
                }
            }
            await context.SaveChangesAsync();
            NavManager.NavigateTo($"/pages?openSiteId={SiteId}");
        }
        catch (Exception ex) { Console.WriteLine("Kayıt Hatası: " + ex.Message); }
    }

    private async Task UploadFiles(InputFileChangeEventArgs e, string type)
    {
        isUploading = true;
        uploadStatus = "Yükleniyor...";
        await InvokeAsync(StateHasChanged);
        await Task.Delay(1);

        try
        {
            var webRoot = WebEnvironment.WebRootPath ?? Path.Combine(Directory.GetCurrentDirectory(), "wwwroot");
            var actualType = type == "gallery_single" ? "gallery" : type;
            var uploadPath = Path.Combine(webRoot, "uploads", actualType);

            if (!Directory.Exists(uploadPath))
                Directory.CreateDirectory(uploadPath);

            var maxFiles = (type == "gallery" || type == "gallery_single") ? 20 : 1;
            long maxFileSize = 100 * 1024 * 1024;

            IReadOnlyList<IBrowserFile> files;
            try
            {
                files = e.GetMultipleFiles(maxFiles);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Dosya seçimi hatası: {ex.Message}");
                return;
            }

            foreach (var file in files)
            {
                if (file.Size > maxFileSize) continue;

                var fileName = $"{Guid.NewGuid()}{Path.GetExtension(file.Name)}";
                var filePath = Path.Combine(uploadPath, fileName);

                using (var stream = file.OpenReadStream(maxAllowedSize: maxFileSize))
                using (var fs = new FileStream(filePath, FileMode.Create))
                {
                    await stream.CopyToAsync(fs);
                }

                var fileUrl = $"/uploads/{actualType}/{fileName}";

                if (type == "slider") tempSlider.ImageUrl = fileUrl;
                else if (type == "news") tempNews.ImageUrl = fileUrl;
                else if (type == "announcements") tempAnnouncement.ImageUrl = fileUrl;
                else if (type == "gallery_single") tempGallery.ImageUrl = fileUrl;
                else if (type == "gallery") pageData.GalleryItems.Add(new GalleryItem { ImageUrl = fileUrl });
            }
            uploadStatus = "✔ Başarıyla yüklendi!";
        }
        catch (Exception ex) { Console.WriteLine($"Upload hatası: {ex}"); }
        finally { isUploading = false; await InvokeAsync(StateHasChanged); }
    }

    private void AddSliderItem()
    {
        if (!string.IsNullOrEmpty(tempSlider.ImageUrl))
        {
            pageData.Sliders.Add(new SliderItem { ImageUrl = tempSlider.ImageUrl, Title = tempSlider.Title, LinkUrl = tempSlider.LinkUrl });
            tempSlider = new();
        }
    }

    private void EditSliderItem(int index)
    {
        editingSliderIndex = index;
        var item = pageData.Sliders[index];
        tempSlider = new SliderItem { ImageUrl = item.ImageUrl, Title = item.Title, LinkUrl = item.LinkUrl };
    }

    private void SaveSliderEdit()
    {
        if (editingSliderIndex.HasValue && editingSliderIndex.Value < pageData.Sliders.Count)
        {
            var item = pageData.Sliders[editingSliderIndex.Value];
            if (!string.IsNullOrEmpty(tempSlider.ImageUrl)) item.ImageUrl = tempSlider.ImageUrl;
            item.Title = tempSlider.Title;
            item.LinkUrl = tempSlider.LinkUrl;
            editingSliderIndex = null;
            tempSlider = new();
        }
    }

    private void CancelSliderEdit() { editingSliderIndex = null; tempSlider = new(); }

    private void AddNewsItem()
    {
        if (!string.IsNullOrEmpty(tempNews.Title))
        {
            pageData.NewsItems.Add(new NewsItem { Title = tempNews.Title, Summary = tempNews.Summary, ImageUrl = tempNews.ImageUrl, LinkUrl = tempNews.LinkUrl, Content = tempNews.Content });
            tempNews = new();
        }
    }

    private void EditNewsItem(int index)
    {
        editingNewsIndex = index;
        var item = pageData.NewsItems[index];
        tempNews = new NewsItem { Title = item.Title, Summary = item.Summary, ImageUrl = item.ImageUrl, LinkUrl = item.LinkUrl, Content = item.Content };
    }

    private void SaveNewsEdit()
    {
        if (editingNewsIndex.HasValue && editingNewsIndex.Value < pageData.NewsItems.Count)
        {
            var item = pageData.NewsItems[editingNewsIndex.Value];
            item.Title = tempNews.Title;
            item.Summary = tempNews.Summary;
            if (!string.IsNullOrEmpty(tempNews.ImageUrl)) item.ImageUrl = tempNews.ImageUrl;
            item.LinkUrl = tempNews.LinkUrl;
            item.Content = tempNews.Content;
            editingNewsIndex = null;
            tempNews = new();
        }
    }

    private void CancelNewsEdit() { editingNewsIndex = null; tempNews = new(); }

    private void AddAnnouncementItem()
    {
        if (!string.IsNullOrEmpty(tempAnnouncement.Title))
        {
            pageData.Announcements.Add(new AnnouncementItem { Title = tempAnnouncement.Title, ImageUrl = tempAnnouncement.ImageUrl, LinkUrl = tempAnnouncement.LinkUrl, Content = tempAnnouncement.Content });
            tempAnnouncement = new();
        }
    }

    private void EditAnnouncementItem(int index)
    {
        editingAnnouncementIndex = index;
        var item = pageData.Announcements[index];
        tempAnnouncement = new AnnouncementItem { Title = item.Title, ImageUrl = item.ImageUrl, LinkUrl = item.LinkUrl, Content = item.Content };
    }

    private void SaveAnnouncementEdit()
    {
        if (editingAnnouncementIndex.HasValue && editingAnnouncementIndex.Value < pageData.Announcements.Count)
        {
            var item = pageData.Announcements[editingAnnouncementIndex.Value];
            item.Title = tempAnnouncement.Title;
            if (!string.IsNullOrEmpty(tempAnnouncement.ImageUrl)) item.ImageUrl = tempAnnouncement.ImageUrl;
            item.LinkUrl = tempAnnouncement.LinkUrl;
            item.Content = tempAnnouncement.Content;
            editingAnnouncementIndex = null;
            tempAnnouncement = new();
        }
    }

    private void CancelAnnouncementEdit() { editingAnnouncementIndex = null; tempAnnouncement = new(); }

    private void AddGalleryItem()
    {
        if (!string.IsNullOrEmpty(tempGallery.ImageUrl))
        {
            pageData.GalleryItems.Add(new GalleryItem { ImageUrl = tempGallery.ImageUrl, Title = tempGallery.Title, Description = tempGallery.Description, SelectedPages = tempGallery.SelectedPages?.ToList() ?? new List<string>() });
            tempGallery = new();
        }
    }

    private void EditGalleryItem(int index)
    {
        editingGalleryIndex = index;
        var item = pageData.GalleryItems[index];
        tempGallery = new GalleryItem { ImageUrl = item.ImageUrl, Title = item.Title, Description = item.Description, SelectedPages = item.SelectedPages?.ToList() ?? new List<string>() };
    }

    private void SaveGalleryEdit()
    {
        if (editingGalleryIndex.HasValue && editingGalleryIndex.Value < pageData.GalleryItems.Count)
        {
            var item = pageData.GalleryItems[editingGalleryIndex.Value];
            if (!string.IsNullOrEmpty(tempGallery.ImageUrl)) item.ImageUrl = tempGallery.ImageUrl;
            item.Title = tempGallery.Title;
            item.Description = tempGallery.Description;
            item.SelectedPages = tempGallery.SelectedPages?.ToList() ?? new List<string>();
            editingGalleryIndex = null;
            tempGallery = new();
        }
    }

    private void CancelGalleryEdit() { editingGalleryIndex = null; tempGallery = new(); }

    private void ToggleGalleryPage(string pageSlug, bool isChecked)
    {
        tempGallery.SelectedPages ??= new List<string>();
        if (isChecked && !tempGallery.SelectedPages.Contains(pageSlug)) tempGallery.SelectedPages.Add(pageSlug);
        else if (!isChecked && tempGallery.SelectedPages.Contains(pageSlug)) tempGallery.SelectedPages.Remove(pageSlug);
    }

    private bool IsVideo(string url)
    {
        if (string.IsNullOrEmpty(url)) return false;
        var ext = Path.GetExtension(url).ToLower();
        return ext == ".mp4" || ext == ".webm" || ext == ".ogg" || ext == ".mov";
    }

    private void ClearNavigations(Page p) { try { var t = p.GetType().GetProperty("Tenant"); if (t != null) t.SetValue(p, null); var pp = p.GetType().GetProperty("ParentPage"); if (pp != null) pp.SetValue(p, null); } catch { } }
    private void GoBack() => NavManager.NavigateTo($"/pages?openSiteId={SiteId}");

    private void OpenPreview()
    {
        if (!string.IsNullOrEmpty(pageModel.Slug))
        {
            var url = $"https://sinavkurs.localhost:7156/view/{pageModel.Slug}";
            NavManager.NavigateTo(url, forceLoad: true);
        }
    }

    public class PageContentData
    {
        public string PageType { get; set; } = "Standard";
        public bool HasSlider { get; set; }
        public List<SliderItem> Sliders { get; set; } = new();
        public bool HasNews { get; set; }
        public List<NewsItem> NewsItems { get; set; } = new();
        public bool HasAnnouncements { get; set; }
        public List<AnnouncementItem> Announcements { get; set; } = new();
        public bool HasGallery { get; set; }
        public List<GalleryItem> GalleryItems { get; set; } = new();
        public string HtmlContent { get; set; } = "";
        public ContactInfo Contact { get; set; } = new();
    }

    public class ContactInfo
    {
        public string PhoneLabel1 { get; set; }
        public string Phone1 { get; set; }
        public string PhoneLabel2 { get; set; }
        public string Phone2 { get; set; }
        public string Email1 { get; set; }
        public string Email2 { get; set; }
        public string AddressText { get; set; }
        public string City { get; set; }
        public string District { get; set; }
        public string MapEmbedCode { get; set; }
        public string WorkingDays { get; set; }
        public string WorkingHours { get; set; }
        public string Whatsapp { get; set; }
        public string Instagram { get; set; }
        public string Facebook { get; set; }
        public string Twitter { get; set; }
    }

    public class SliderItem { public string ImageUrl { get; set; } = ""; public string Title { get; set; } = ""; public string LinkUrl { get; set; } }
    public class NewsItem { public string Title { get; set; } public string Summary { get; set; } public string ImageUrl { get; set; } public string LinkUrl { get; set; } public string Content { get; set; } }
    public class AnnouncementItem { public string Title { get; set; } public string ImageUrl { get; set; } public string LinkUrl { get; set; } public string Content { get; set; } }
    public class GalleryItem { public string ImageUrl { get; set; } public string Title { get; set; } public string Description { get; set; } public List<string> SelectedPages { get; set; } = new(); }
}