@page "/pages"
@using CoreBuilder.Entities
@using CoreBuilder.Data
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject NavigationManager NavManager
@rendermode InteractiveServer

<div class="container-fluid p-0">
    <div class="card shadow-sm mb-4 border-primary border-top border-3">
        <div class="card-body bg-light">
            <label class="form-label fw-bold text-primary mb-2">
                <i class="fa-solid fa-filter me-1"></i> İşlem Yapılacak Siteyi Seçin:
            </label>

            @if (tenants == null)
            {
                <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
            }
            else
            {
                <select class="form-select form-select-lg shadow-sm" @bind="selectedTenantId" @bind:after="OnTenantChanged">
                    <option value="0">-- Lütfen Bir Site Seçiniz --</option>
                    @foreach (var t in tenants)
                    {
                        <option value="@t.Id">@t.SiteName (@t.Domain)</option>
                    }
                </select>
            }
        </div>
    </div>

    @if (selectedTenantId > 0)
    {
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0 text-dark">
                <i class="fa-solid fa-layer-group me-2"></i>
                <span class="fw-bold">@selectedSiteName</span> - Mevcut Sayfalar
            </h5>
            <button class="btn btn-primary shadow-sm" @onclick="GoToCreate">
                <i class="fa-solid fa-plus me-1"></i> Yeni Sayfa Ekle
            </button>
        </div>

        @if (pagesList == null)
        {
            <div class="text-center py-5"><div class="spinner-border text-primary me-2"></div> Yükleniyor...</div>
        }
        else if (pagesList.Count == 0)
        {
            <div class="alert alert-info shadow-sm">Bu siteye ait sayfa yok.</div>
        }
        else
        {
            <div class="card shadow border-0">
                <div class="card-body p-0">
                    <table class="table table-hover table-striped mb-0 align-middle">
                        <thead class="bg-primary text-white">
                            <tr>
                                <th class="ps-4" style="width: 120px;">Sıralama</th>
                                <th>Başlık</th>
                                <th>URL</th>
                                <th>Durum</th>
                                <th class="text-end pe-4" style="width: 150px;">İşlemler</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in pagesList)
                            {
                                <tr>
                                    <td class="ps-4">
                                        <div class="btn-group btn-group-sm shadow-sm">
                                            <button class="btn btn-light border text-secondary" @onclick="() => MovePage(item, -1)" title="Yukarı Taşı">
                                                <i class="fa-solid fa-arrow-up"></i>
                                            </button>
                                            <button class="btn btn-light border text-secondary" @onclick="() => MovePage(item, 1)" title="Aşağı Taşı">
                                                <i class="fa-solid fa-arrow-down"></i>
                                            </button>
                                        </div>
                                    </td>
                                    <td>
                                        @if (item.ParentId != null && item.ParentId > 0)
                                        {
                                            <span class="text-muted ms-4 me-1" style="font-size: 1.2em;">↳</span>
                                            <span class="text-dark">@item.Title</span>
                                        }
                                        else
                                        {
                                            <span class="fw-bold text-primary">@item.Title</span>
                                        }
                                    </td>
                                    <td><span class="badge bg-light text-dark border">/@item.Slug</span></td>
                                    <td>
                                        @if (item.IsPublished)
                                        {
                                            <span class="badge bg-success">Yayında</span>
                                        }
                                        else
                                        {

                                            <span class="badge bg-secondary">Taslak</span>
                                        }
                                    </td>
                                    <td class="text-end pe-4">
                                        <a href="@($"/editpage/{item.Id}/{selectedTenantId}")" class="btn btn-sm btn-outline-primary me-1"><i class="fa-solid fa-pen"></i></a>
                                        <button class="btn btn-sm btn-outline-danger" @onclick="() => DeletePage(item.Id)"><i class="fa-solid fa-trash"></i></button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }
    }
</div>

@code {
    [SupplyParameterFromQuery]
    public int? OpenSiteId { get; set; }

    private List<Tenant>? tenants;
    private List<Page>? pagesList;
    private int selectedTenantId = 0;
    private string selectedSiteName = "";

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();
        tenants = await context.Tenants.IgnoreQueryFilters().ToListAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        if (OpenSiteId.HasValue && OpenSiteId.Value > 0 && tenants != null)
        {
            selectedTenantId = OpenSiteId.Value;
            await OnTenantChanged();
        }
    }

    private async Task OnTenantChanged()
    {
        if (selectedTenantId > 0)
        {
            using var context = DbFactory.CreateDbContext();
            var site = tenants?.FirstOrDefault(t => t.Id == selectedTenantId);
            selectedSiteName = site?.SiteName ?? "";
            await LoadPages(selectedTenantId);
        }
        else
        {
            pagesList = null;
        }
    }

    private async Task LoadPages(int tenantId)
    {
        using var context = DbFactory.CreateDbContext();
        var allPages = await context.Pages
            .IgnoreQueryFilters()
            .AsNoTracking()
            .Where(p => p.TenantId == tenantId)
            .OrderBy(p => p.Order)
            .ToListAsync();

        var sortedList = new List<Page>();
        var rootPages = allPages.Where(p => p.ParentId == null || p.ParentId == 0).ToList();

        foreach (var parent in rootPages)
        {
            sortedList.Add(parent);
            var children = allPages.Where(p => p.ParentId == parent.Id).ToList();
            if (children.Any()) sortedList.AddRange(children);
        }
        pagesList = sortedList;
    }

    // --- HATAYI ÇÖZEN KISIM BURASI ---
    private async Task MovePage(Page item, int direction)
    {
        using var context = DbFactory.CreateDbContext();

        // 1. Kardeşleri çekiyoruz (Bunlar şu an context tarafından İZLENİYOR)
        var siblings = await context.Pages
            .IgnoreQueryFilters() // Silinenleri vb. görebilsin
            .Where(p => p.TenantId == selectedTenantId && p.ParentId == item.ParentId)
            .OrderBy(p => p.Order)
            .ToListAsync();

        // 2. Dışarıdan gelen 'item' nesnesi yerine, listedeki 'CANLI' nesneyi buluyoruz
        var currentEntity = siblings.FirstOrDefault(p => p.Id == item.Id);

        // Eğer bir terslik olur da bulamazsa işlemi durdur
        if (currentEntity == null) return;

        // 3. İndeks hesaplamaları
        var currentIndex = siblings.IndexOf(currentEntity);
        var newIndex = currentIndex + direction;

        // 4. Liste sınırlarını kontrol et
        if (newIndex >= 0 && newIndex < siblings.Count)
        {
            // Hedefteki canlı nesne
            var targetEntity = siblings[newIndex];

            // 5. Sıraları değiştir (Takas)
            int tempOrder = currentEntity.Order;
            currentEntity.Order = targetEntity.Order;
            targetEntity.Order = tempOrder;

            // Eğer order numaraları bozuksa ve eşitse manuel kaydır
            if (currentEntity.Order == targetEntity.Order)
            {
                currentEntity.Order += direction;
            }

            // 6. Kaydet
            // Burada 'Update' çağırmamıza gerek yok çünkü 'siblings' listesi
            // veritabanından context ile çekildiği için zaten takip ediliyor.
            // Sadece SaveChanges yeteli.
            await context.SaveChangesAsync();

            // Listeyi yenile
            await LoadPages(selectedTenantId);
        }
    }

    private async Task DeletePage(int pageId)
    {
        using var context = DbFactory.CreateDbContext();
        var page = await context.Pages.IgnoreQueryFilters().FirstOrDefaultAsync(p => p.Id == pageId);
        if (page != null)
        {
            context.Pages.Remove(page);
            await context.SaveChangesAsync();
            await LoadPages(selectedTenantId);
        }
    }

    private void GoToCreate()
    {
        if (selectedTenantId > 0)
            NavManager.NavigateTo($"/editpage/0/{selectedTenantId}");
    }
}