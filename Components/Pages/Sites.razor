@page "/sites"
@using CoreBuilder.Entities
@using CoreBuilder.Data
@using Microsoft.EntityFrameworkCore
@inject ApplicationDbContext DbContext
@inject NavigationManager NavManager
@rendermode InteractiveServer

<div class="d-flex justify-content-between align-items-center mb-4">
    <h3><i class="fa-solid fa-globe text-primary"></i> Site Yönetimi</h3>
    <button class="btn btn-primary" @onclick="GoToCreate">
        <i class="fa-solid fa-plus"></i> Yeni Site Oluştur
    </button>
</div>

@if (tenants == null)
{
    <p><em>Yükleniyor...</em></p>
}
else if (!tenants.Any())
{
    <div class="alert alert-info">Henüz hiç site oluşturulmamış.</div>
}
else
{
    <div class="card shadow-sm">
        <div class="card-body p-0">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Site Adı</th>
                        <th>Domain</th>
                        <th>Kategori</th>
                        <th>Durum</th>
                        <th class="text-end">İşlemler</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var site in tenants)
                    {
                        <tr>
                            <td class="align-middle fw-bold">@site.SiteName</td>
                            <td class="align-middle"><span class="badge bg-light text-dark border">@site.Domain</span></td>
                            <td class="align-middle">@site.Category</td>
                            <td class="align-middle">
                                @if (site.IsActive)
                                {
                                    <span class="badge bg-success">Aktif</span>
                                }
                                else
                                {
                                    <span class="badge bg-danger">Pasif</span>
                                }
                            </td>
                            <td class="text-end">
                                <a href="/sites/edit/@site.Id" class="btn btn-sm btn-outline-primary me-1" title="Düzenle">
                                    <i class="fa-solid fa-pen"></i>
                                </a>
                                <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteSite(site)"><i class="fa-solid fa-trash"></i></button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
}

@code {
    private List<Tenant>? tenants;

    protected override async Task OnInitializedAsync()
    {
        // Veritabanından tüm siteleri çekiyoruz
        tenants = await DbContext.Tenants.ToListAsync();
    }

    private void GoToCreate()
    {
        // Yeni oluşturacağımız sayfaya yönlendiriyoruz
        NavManager.NavigateTo("/sites/create");
    }

    private async Task DeleteSite(Tenant site)
    {
        DbContext.Tenants.Remove(site);
        await DbContext.SaveChangesAsync();
        tenants = await DbContext.Tenants.ToListAsync(); // Listeyi güncelle
    }
}