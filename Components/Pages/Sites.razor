@page "/sites"
@using CoreBuilder.Entities
@using CoreBuilder.Data
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject NavigationManager NavManager

<div class="container-fluid p-0">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="text-primary"><i class="fa-solid fa-globe me-2"></i>Site Yönetimi</h3>
        <a href="/sites/create" class="btn btn-primary shadow-sm">
            <i class="fa-solid fa-plus me-1"></i> Yeni Site Oluştur
        </a>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2 text-muted">Siteler yükleniyor...</p>
        </div>
    }
    else if (tenants == null || !tenants.Any())
    {
        <div class="alert alert-warning border-0 shadow-sm">
            <i class="fa-solid fa-triangle-exclamation me-2"></i> Henüz hiç site eklenmemiş.
        </div>
    }
    else
    {
        <div class="card shadow border-0">
            <div class="card-body p-0">
                <table class="table table-hover table-striped mb-0 align-middle">
                    <thead class="bg-light">
                        <tr>
                            <th class="ps-4">Site Adı</th>
                            <th>Domain</th>
                            <th>Kategori</th>
                            <th>Durum</th>
                            <th class="text-end pe-4">İşlemler</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var site in tenants)
                        {
                            <tr>
                                <td class="ps-4 fw-bold">@site.SiteName</td>
                                <td>
                                    <a href="http://@site.Domain" target="_blank" class="text-decoration-none">
                                        <i class="fa-solid fa-arrow-up-right-from-square me-1 small"></i> @site.Domain
                                    </a>
                                </td>
                                <td><span class="badge bg-info text-dark">@site.Category</span></td>
                                <td>
                                    @if (site.IsActive)
                                    {
                                        <span class="badge bg-success rounded-pill">Aktif</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary rounded-pill">Pasif</span>
                                    }
                                </td>
                                <td class="text-end pe-4">
                                    <div class="btn-group shadow-sm">
                                        <a href="http://@site.Domain" target="_blank" class="btn btn-sm btn-outline-secondary" title="Siteye Git">
                                            <i class="fa-solid fa-eye"></i>
                                        </a>

                                        <a href="/sites/edit/@site.Id" class="btn btn-sm btn-outline-primary" title="Düzenle">
                                            <i class="fa-solid fa-pen"></i>
                                        </a>

                                        <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteSite(site.Id)" title="Sil">
                                            <i class="fa-solid fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
</div>

@code {
    private List<Tenant>? tenants;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        // FABRİKA YÖNTEMİ
        using var context = DbFactory.CreateDbContext();
        tenants = await context.Tenants.IgnoreQueryFilters().ToListAsync();
        isLoading = false;
    }

    private async Task DeleteSite(int id)
    {
        // Silerken kullanıcıya sormak iyi olabilir ama şimdilik direkt siliyoruz
        using var context = DbFactory.CreateDbContext();
        var site = await context.Tenants.FindAsync(id);
        if (site != null)
        {
            context.Tenants.Remove(site);
            await context.SaveChangesAsync();

            // Listeyi yenile
            tenants = await context.Tenants.IgnoreQueryFilters().ToListAsync();
        }
    }
}